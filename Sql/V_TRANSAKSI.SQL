
CREATE
    VIEW `pusb8564_dataku`.`V_TRANSAKSI` 
    AS
(SELECT m1.ID, IF(m3.TYPE IS NULL, 'PASCABAYAR', m3.TYPE) AS TYPE, m1.ID_REFFERENCE, m1.ID_TRANSAKSI, m1.KODE_PRODUK, m1.NO_PELANGGAN, m1.JUMLAH_BAYAR, 
CASE
WHEN m1.STATUS_TRANSAKSI = '00' THEN '1'
ELSE m1.STATUS_TRANSAKSI
END
AS ERROR_CODE, 
CASE
WHEN m1.PESAN = '' THEN 'PROSES'
WHEN m1.PESAN = 'PAYMENT SUCCESS' THEN 'SUKSES'
WHEN m1.PESAN = 'SUCCESS' THEN 'SUKSES'
WHEN m1.PESAN = 'FAILED' THEN 'GAGAL'
WHEN m1.PESAN = 'UNDEFINED ERROR' THEN 'GAGAL'
WHEN m1.PESAN = 'INCORRECT DESTINATION NUMBER' THEN 'NOMOR TUJUAN SALAH'
WHEN m1.PESAN = 'CUSTOMER NUMBER BLOCKED' THEN 'NOMOR PELANGGAN DIBLOKIR'
WHEN m1.PESAN = 'NUMBER NOT MATCH WITH OPERATOR' THEN 'NOMOR TIDAK SESUAI DENGAN OPERATOR'
WHEN m1.PESAN = 'PRODUCT IS TEMPORARILY OUT OF SERVICE' THEN 'PRODUK SEMENTARA TIDAK TERSEDIA'
ELSE m1.PESAN
END
AS ERROR_MESSAGE, 
m1.SN, m1.CREATED_DATE, m1.CREATED_BY, m1.UPDATED_DATE, m1.UPDATED_BY
FROM TRANSAKSI m1 LEFT JOIN TRANSAKSI m2
ON (m1.ID_REFFERENCE = m2.ID_REFFERENCE AND m1.ID < m2.ID)
LEFT JOIN V_PRODUK AS m3 ON m3.CODE = m1.KODE_PRODUK
WHERE m2.ID IS NULL 
ORDER BY m1.CREATED_DATE DESC);
